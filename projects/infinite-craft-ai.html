<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Infinite Craft Visualizer – CatSu</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://catsu-osm.github.io/styles.css">
<style>
/* keep previous scoped variables */
#icv-app {
  --icv-bg:#edf0f5;--icv-panel:#fff;--icv-panel-border:#d5d8df;--icv-panel-header:#dfe7f5;
  --icv-text:#0f172a;--icv-text-muted:#6b7280;--icv-badge:#edf1f5;--icv-badge-text:#1f2937;
  --icv-inv-chip-bg:#0f172a;--icv-inv-chip-text:#fff;--icv-craftable-bg:#f8fafc;--icv-craftable-border:#e2e8f0;
  --icv-row-hover:#f2f6ff;--icv-row-selected:#dbeafe;--icv-input-bg:#fff;--icv-input-border:#cbd5e1;
  --icv-pill:#0ea5e9;--icv-trace-good:#16a34a;--icv-trace-miss:#b91c1c;
}
#icv-app.icv-dark {
  --icv-bg:#0f172a;--icv-panel:#111827;--icv-panel-border:#1f2937;--icv-panel-header:#1f2937;
  --icv-text:#e2e8f0;--icv-text-muted:#94a3b8;--icv-badge:#1f2937;--icv-badge-text:#e2e8f0;
  --icv-inv-chip-bg:#0ea5e9;--icv-inv-chip-text:#0f172a;--icv-craftable-bg:#0f172a;--icv-craftable-border:#1f2937;
  --icv-row-hover:#162036;--icv-row-selected:#162036;--icv-input-bg:#0f172a;--icv-input-border:#1f2937;
  --icv-pill:#0ea5e9;
}
.icv-shell{background:var(--icv-bg);border-radius:8px;}
.icv-layout{display:grid;grid-template-columns:280px minmax(0,1fr);gap:1rem;}
.icv-left{background:var(--icv-panel);border:1px solid var(--icv-panel-border);border-radius:8px;display:flex;flex-direction:column;}
.icv-left-head{background:var(--icv-panel-header);padding:.6rem .8rem .3rem;}
.icv-left-head h2{margin:0;font-size:1rem;color:var(--icv-text);}
.icv-left-head small{font-size:.7rem;color:var(--icv-text-muted);}
.icv-search{padding:.6rem .8rem;background:var(--icv-panel);}
.icv-search input{width:100%;padding:.35rem .4rem;border:1px solid var(--icv-input-border);background:var(--icv-input-bg);border-radius:4px;font-size:.8rem;color:var(--icv-text);}
.icv-elements-list{flex:1;overflow-y:auto;}
.icv-element-row{display:flex;align-items:center;gap:.35rem;padding:.35rem .6rem;border-bottom:1px solid rgba(243,244,246,.03);cursor:pointer;}
.icv-element-row:hover{background:var(--icv-row-hover);}
.icv-element-row.icv-inv{background:var(--icv-row-selected);}
.icv-el-name{flex:1;font-size:.8rem;color:var(--icv-text);}
.icv-badge{font-size:.6rem;background:var(--icv-badge);border-radius:999px;padding:2px 6px;color:var(--icv-badge-text);}
.icv-badge-base{background:#22c55e1a;color:#22c55e;}
.icv-inv-pill{font-size:.6rem;background:var(--icv-pill);color:#fff;border-radius:999px;padding:2px 6px;}
.icv-right{display:flex;flex-direction:column;gap:1rem;}
.icv-card{background:var(--icv-panel);border:1px solid var(--icv-panel-border);border-radius:8px;overflow:hidden;}
.icv-card-header{background:var(--icv-panel-header);padding:.6rem .8rem;font-size:1rem;color:var(--icv-text);}
.icv-card-header-inline{background:var(--icv-panel-header);padding:.6rem .8rem;display:flex;justify-content:space-between;align-items:center;}
.icv-card-body{padding:.6rem .8rem .8rem;}
.icv-empty{font-size:.8rem;color:var(--icv-text-muted);}
.icv-inventory-chips{display:flex;flex-wrap:wrap;gap:.4rem;}
.icv-chip{background:var(--icv-inv-chip-bg);color:var(--icv-inv-chip-text);padding:2px 10px;border-radius:999px;font-size:.67rem;}
.icv-craftable-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:.6rem;}
.icv-craftable-item{background:var(--icv-craftable-bg);border:1px solid var(--icv-craftable-border);border-radius:6px;padding:.4rem .5rem;}
.icv-craftable-name{font-weight:600;font-size:.8rem;color:var(--icv-text);}
.icv-recipe-line{font-size:.7rem;color:var(--icv-text-muted);}
.icv-header-actions-btn{background:rgba(15,23,42,.06);border:1px solid rgba(15,23,42,.12);border-radius:999px;padding:.25rem .6rem;font-size:.7rem;cursor:pointer;}
#icv-app.icv-dark .icv-header-actions-btn{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);color:#e2e8f0;}
.icv-steps-input{width:4rem;padding:.2rem .35rem;border-radius:5px;border:1px solid var(--icv-input-border);background:var(--icv-input-bg);color:var(--icv-text);font-size:.7rem;}
.icv-trace-list{display:flex;flex-direction:column;gap:.35rem;}
.icv-trace-step{padding:.3rem .4rem;border-left:3px solid transparent;background:rgba(248,250,252,.05);border-radius:4px;font-size:.72rem;}
.icv-trace-ok{border-left-color:var(--icv-trace-good);}
.icv-trace-miss{border-left-color:var(--icv-trace-miss);}
.icv-trace-small{font-size:.65rem;color:var(--icv-text-muted);}
.icv-trace-title{font-weight:600;}
@media(max-width:900px){.icv-layout{grid-template-columns:1fr;}}
</style>
</head>

<body>
<header>
  <h2><a href="https://catsu-osm.github.io" style="text-decoration:none;"><i class="fas fa-home" style="margin-right:10px;"></i></a>CatSu's Website</h2>
  <nav>
    <button onclick="location.href='https://catsu-osm.github.io/projects'">Projects</button>
    <button onclick="location.href='https://catsu-osm.github.io/resources'">Resources</button>
  </nav>
</header>

<main>
<div id="icv-app" class="icv-shell">
<div class="icv-layout">
  <section class="icv-left">
    <div class="icv-left-head">
      <h2>Infinite Craft Elements</h2>
      <small>Click to add/remove from inventory, right-click to trace</small>
    </div>
    <div class="icv-search"><input id="icv-search-input" type="text" placeholder="Filter elements..."></div>
    <div class="icv-elements-list" id="icv-elements-list"></div>
  </section>

  <section class="icv-right">
    <div class="icv-card"><div class="icv-card-header">Your Inventory</div><div class="icv-card-body" id="icv-inventory-body"><p class="icv-empty">No elements selected.</p></div></div>
    <div class="icv-card"><div class="icv-card-header">Craftable Right Now</div><div class="icv-card-body" id="icv-craftable-body"><p class="icv-empty">Select elements to see results.</p></div></div>
    <div class="icv-card"><div class="icv-card-header-inline"><span>Almost Craftable (≤ steps)</span><input id="icv-steps" class="icv-steps-input" type="number" min="1" max="100" value="4"></div><div class="icv-card-body" id="icv-almost-body"><p class="icv-empty">Pick elements first.</p></div></div>
    <div class="icv-card"><div class="icv-card-header">Trace Element (bases only)</div><div class="icv-card-body" id="icv-trace-body"><p class="icv-empty">Right-click an element to trace it from bases.</p></div></div>
    <div class="icv-card"><div class="icv-card-header-inline"><span>Source</span><div style="display:flex;gap:.4rem;"><button id="icv-reload" class="icv-header-actions-btn">Reload</button><button id="icv-dark-toggle" class="icv-header-actions-btn">Dark</button></div></div><div class="icv-card-body"><p style="font-size:.7rem;color:var(--icv-text-muted);">Loaded from <code>docs/infinite_craft_recipes.json</code>.</p><p id="icv-source-status" style="font-size:.7rem;color:var(--icv-text-muted);"></p></div></div>
  </section>
</div></div>
</main>

<footer><p>&copy; CatSu 2023</p></footer>

<script>
const BASE_URL="../docs/infinite_craft_recipes.json";
const app=document.getElementById("icv-app");
const searchInput=document.getElementById("icv-search-input");
const listEl=document.getElementById("icv-elements-list");
const invBody=document.getElementById("icv-inventory-body");
const craftBody=document.getElementById("icv-craftable-body");
const almostBody=document.getElementById("icv-almost-body");
const traceBody=document.getElementById("icv-trace-body");
const statusEl=document.getElementById("icv-source-status");
const reloadBtn=document.getElementById("icv-reload");
const darkBtn=document.getElementById("icv-dark-toggle");
const stepsInput=document.getElementById("icv-steps");

let recipes={},allNames=[],inventory=new Set(),currentTraceTarget=null;

/* dark mode init */
(function(){const s=localStorage.getItem("icv-theme");if(s==="dark")app.classList.add("icv-dark");darkBtn.textContent=app.classList.contains("icv-dark")?"Light":"Dark";})();
darkBtn.onclick=()=>{app.classList.toggle("icv-dark");const d=app.classList.contains("icv-dark");localStorage.setItem("icv-theme",d?"dark":"light");darkBtn.textContent=d?"Light":"Dark";};

function isBase(n){return recipes[n]&&recipes[n]._base===true;}
function getRecipeOptions(n){return recipes[n]&&Array.isArray(recipes[n].recipes)?recipes[n].recipes:[];}
function canMakeWithInventory(n,inv){if(inv.has(n))return false;const o=getRecipeOptions(n);if(!o.length)return false;return o.some(r=>r.every(i=>inv.has(i)));}

function renderElements(filter=""){listEl.innerHTML="";const ft=filter.toLowerCase().trim();
for(const n of allNames){if(ft&&!n.toLowerCase().includes(ft))continue;const row=document.createElement("div");
row.className="icv-element-row"+(inventory.has(n)?" icv-inv":"");row.dataset.name=n;
row.innerHTML=`<div class="icv-el-name">${n}</div><span class="icv-badge${isBase(n)?" icv-badge-base":""}">${isBase(n)?"BASE":"CRAFTABLE"}</span>${inventory.has(n)?'<span class="icv-inv-pill">IN</span>':""}`;
row.onclick=()=>{inventory.has(n)?inventory.delete(n):inventory.add(n);renderInventory();renderCraftables();renderAlmost();if(currentTraceTarget===n)renderTraceFor(n);renderElements(searchInput.value);};
row.oncontextmenu=e=>{e.preventDefault();currentTraceTarget=n;renderTraceFor(n);};
listEl.appendChild(row);}}

/* render functions */
function renderInventory(){invBody.innerHTML=inventory.size?Array.from(inventory).sort().map(n=>`<span class="icv-chip">${n}</span>`).join(" "):'<p class="icv-empty">No elements selected.</p>';}

/* craftables + almost same as before */
function renderCraftables(){craftBody.innerHTML="";if(!inventory.size){craftBody.innerHTML='<p class="icv-empty">Select elements.</p>';return;}
const c=allNames.filter(n=>canMakeWithInventory(n,inventory));if(!c.length){craftBody.innerHTML='<p class="icv-empty">Nothing craftable.</p>';return;}
craftBody.innerHTML='<div class="icv-craftable-grid">'+c.map(el=>{const lines=getRecipeOptions(el).filter(r=>r.every(x=>inventory.has(x))).map(r=>`<div class="icv-recipe-line"><strong>${el}</strong> = ${r.join(" + ")}</div>`).join("");return `<div class="icv-craftable-item"><div class="icv-craftable-name">${el}</div>${lines}</div>`;}).join("")+'</div>';}

/* forward reach for almost */
function computeReach(maxSteps){const level0=new Set(inventory),map={};level0.forEach(n=>map[n]=0);let cur=new Set(level0);
for(let s=1;s<=maxSteps;s++){const newOnes=[];for(const n of allNames){if(map[n]!=null)continue;const ok=getRecipeOptions(n).some(r=>r.every(x=>cur.has(x)));if(ok)newOnes.push(n);}if(!newOnes.length)break;newOnes.forEach(n=>{map[n]=s;cur.add(n);});}return map;}
function renderAlmost(){almostBody.innerHTML="";if(!inventory.size){almostBody.innerHTML='<p class="icv-empty">Pick elements first.</p>';return;}
let m=parseInt(stepsInput.value)||4;if(m>100)m=100;if(m<1)m=1;stepsInput.value=m;
const reach=computeReach(m),byStep={};for(const[k,v]of Object.entries(reach))if(v>=2&&v<=m)(byStep[v]=byStep[v]||[]).push(k);
const steps=Object.keys(byStep).map(Number).sort((a,b)=>a-b);if(!steps.length){almostBody.innerHTML=`<p class="icv-empty">Nothing within ${m} steps.</p>`;return;}
almostBody.innerHTML=steps.map(s=>`<div><div class="icv-step-tag">Step ${s}</div><div class="icv-craftable-grid">${byStep[s].sort().map(el=>{const lines=getRecipeOptions(el).filter(r=>r.every(x=>reach[x]!=null&&reach[x]<=s-1)).map(r=>`<div class="icv-recipe-line"><strong>${el}</strong> = ${r.join(" + ")}</div>`).join("");return `<div class="icv-craftable-item"><div class="icv-craftable-name">${el}</div>${lines}</div>`;}).join("")}</div></div>`).join("");}

/* trace only from bases */
function findTrace(target,baseSet,maxDepth=20,visited=new Set()){if(baseSet.has(target))return[{type:"have",name:target}];if(maxDepth<=0)return null;
const opts=getRecipeOptions(target);if(!opts.length)return null;
for(const opt of opts){if(opt.every(x=>baseSet.has(x)))return[...opt.map(x=>({type:"have",name:x})),{type:"make",name:target,recipe:opt}];
if(visited.has(target))continue;const v2=new Set(visited);v2.add(target);let steps=[],tmp=new Set(baseSet),fail=false;
for(const ing of opt){if(!tmp.has(ing)){const sub=findTrace(ing,tmp,maxDepth-1,v2);if(!sub){fail=true;break;}steps=steps.concat(sub);tmp.add(ing);}else steps.push({type:"have",name:ing});}
if(!fail){steps.push({type:"make",name:target,recipe:opt});return steps;}}return null;}

function renderTraceFor(t){traceBody.innerHTML="";if(!t){traceBody.innerHTML='<p class="icv-empty">Right-click an element to trace.</p>';return;}
const baseSet=new Set(allNames.filter(isBase));const trace=findTrace(t,baseSet,20);
if(!trace){traceBody.innerHTML=`<p class="icv-empty">No path found from bases.</p>`;return;}
const list=trace.map(st=>st.type==="make"?`<div class="icv-trace-step icv-trace-ok">🛠️ <strong>${
