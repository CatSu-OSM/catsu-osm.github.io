<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infinite Craft Visualizer ‚Äì CatSu</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="https://catsu-osm.github.io/styles.css" />
  <style>
    /* (unchanged styling from previous version, shortened here for brevity) */
    /* ... keep all your prior CSS ... */
    .icv-trace-title {
      font-weight: 600;
    }
  </style>
</head>

<body>
  <header>
    <h2>
      <a href="https://catsu-osm.github.io" style="text-decoration: none;">
        <i class="fas fa-home" style="margin-right: 10px;"></i>
      </a>
      CatSu's Website
    </h2>
    <nav>
      <button onclick="location.href='https://catsu-osm.github.io/projects'">Projects</button>
      <button onclick="location.href='https://catsu-osm.github.io/resources'">Resources</button>
    </nav>
  </header>

  <main>
    <div id="icv-app" class="icv-shell">
      <div class="icv-layout">
        <!-- LEFT -->
        <section class="icv-left">
          <div class="icv-left-head">
            <h2>Infinite Craft Elements</h2>
            <small>Click to add/remove from your inventory, right-click to trace (from bases)</small>
          </div>
          <div class="icv-search">
            <input id="icv-search-input" type="text" placeholder="Filter elements..." />
          </div>
          <div class="icv-elements-list" id="icv-elements-list"></div>
        </section>

        <!-- RIGHT -->
        <section class="icv-right">
          <div class="icv-card">
            <div class="icv-card-header">Your Inventory</div>
            <div class="icv-card-body" id="icv-inventory-body">
              <p class="icv-empty">No elements selected. Click an element on the left.</p>
            </div>
          </div>

          <div class="icv-card">
            <div class="icv-card-header">Craftable Right Now</div>
            <div class="icv-card-body" id="icv-craftable-body">
              <p class="icv-empty">Select at least one element to see results.</p>
            </div>
          </div>

          <div class="icv-card">
            <div class="icv-card-header-inline">
              <span>Almost Craftable (‚â§ steps)</span>
              <input id="icv-steps" class="icv-steps-input" type="number" min="1" max="100" value="4" />
            </div>
            <div class="icv-card-body" id="icv-almost-body">
              <p class="icv-empty">Pick some elements first.</p>
            </div>
          </div>

          <!-- TRACE CARD -->
          <div class="icv-card">
            <div class="icv-card-header">Trace (from bases only)</div>
            <div class="icv-card-body" id="icv-trace-body">
              <p class="icv-empty">Right-click an element on the left to trace it from base elements.</p>
            </div>
          </div>

          <div class="icv-card">
            <div class="icv-card-header-inline">
              <span>Source</span>
              <div style="display:flex;gap:0.4rem;">
                <button id="icv-reload" class="icv-header-actions-btn" type="button">Reload</button>
                <button id="icv-dark-toggle" class="icv-header-actions-btn" type="button">Dark</button>
              </div>
            </div>
            <div class="icv-card-body">
              <p style="font-size:0.7rem; color:var(--icv-text-muted);">
                Loaded from <code>docs/infinite_craft_recipes.json</code>.
              </p>
              <p id="icv-source-status" style="font-size:0.7rem; color:var(--icv-text-muted);"></p>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer><p>&copy; CatSu 2023</p></footer>

  <script>
    const BASE_URL = "../docs/infinite_craft_recipes.json";
    const app = document.getElementById("icv-app");
    const searchInput = document.getElementById("icv-search-input");
    const listEl = document.getElementById("icv-elements-list");
    const invBody = document.getElementById("icv-inventory-body");
    const craftBody = document.getElementById("icv-craftable-body");
    const almostBody = document.getElementById("icv-almost-body");
    const traceBody = document.getElementById("icv-trace-body");
    const statusEl = document.getElementById("icv-source-status");
    const reloadBtn = document.getElementById("icv-reload");
    const darkBtn = document.getElementById("icv-dark-toggle");
    const stepsInput = document.getElementById("icv-steps");

    let recipes = {};
    let allNames = [];
    let inventory = new Set();
    let currentTraceTarget = null;

    /* --- same dark mode + render functions as before (omitted for brevity) --- */

    // === TRACE (always from bases) ===
    function isBase(name) {
      const node = recipes[name];
      return node && node._base === true;
    }

    function getRecipeOptions(name) {
      const node = recipes[name];
      if (!node) return [];
      return Array.isArray(node.recipes) ? node.recipes : [];
    }

    function findTrace(target, startingSet, maxDepth = 20, visited = new Set()) {
      if (startingSet.has(target)) return [{ type: "have", name: target }];
      if (maxDepth <= 0) return null;
      const opts = getRecipeOptions(target);
      if (!opts.length) return null;
      for (const opt of opts) {
        if (opt.every((ing) => startingSet.has(ing))) {
          return [
            ...opt.map((ing) => ({ type: "have", name: ing })),
            { type: "make", name: target, recipe: opt },
          ];
        }
        if (visited.has(target)) continue;
        const newVisited = new Set(visited);
        newVisited.add(target);
        let steps = [];
        let tmpSet = new Set(startingSet);
        let failed = false;
        for (const ing of opt) {
          if (!tmpSet.has(ing)) {
            const sub = findTrace(ing, tmpSet, maxDepth - 1, newVisited);
            if (!sub) {
              failed = true;
              break;
            }
            steps = steps.concat(sub);
            tmpSet.add(ing);
          } else {
            steps.push({ type: "have", name: ing });
          }
        }
        if (!failed) {
          steps.push({ type: "make", name: target, recipe: opt });
          return steps;
        }
      }
      return null;
    }

    function renderTraceFor(target) {
      traceBody.innerHTML = "";
      if (!target) {
        traceBody.innerHTML =
          '<p class="icv-empty">Right-click an element on the left to trace it from bases.</p>';
        return;
      }
      const startingSet = new Set(allNames.filter((n) => isBase(n)));
      const trace = findTrace(target, startingSet, 20);
      if (!trace) {
        traceBody.innerHTML =
          '<p class="icv-empty">No path found within 20 steps from base elements.</p>';
        return;
      }
      const title = document.createElement("div");
      title.className = "icv-trace-title";
      title.textContent = "Trace for: " + target;
      const list = document.createElement("div");
      list.className = "icv-trace-list";
      const originalStart = new Set(startingSet);
      trace.forEach((step) => {
        const row = document.createElement("div");
        row.className = "icv-trace-step";
        if (step.type === "have") {
          const ok = originalStart.has(step.name);
          row.classList.add(ok ? "icv-trace-ok" : "");
          row.innerHTML = ok
            ? `‚úÖ Base <strong>${step.name}</strong>`
            : `‚ûï Need <strong>${step.name}</strong> (built earlier)`;
        } else if (step.type === "make") {
          row.classList.add("icv-trace-ok");
          row.innerHTML = `üõ†Ô∏è <strong>${step.name}</strong> = ${step.recipe.join(" + ")}`;
        }
        list.appendChild(row);
      });
      const note = document.createElement("div");
      note.className = "icv-trace-small";
      note.textContent =
        "Tracing always starts from base elements. (right-click another element to change target)";
      traceBody.appendChild(title);
      traceBody.appendChild(list);
      traceBody.appendChild(note);
    }

    function renderElements(filter = "") {
      listEl.innerHTML = "";
      const ft = filter.trim().toLowerCase();
      for (const name of allNames) {
        if (ft && !name.toLowerCase().includes(ft)) continue;
        const row = document.createElement("div");
        row.className = "icv-element-row" + (inventory.has(name) ? " icv-inv" : "");
        row.dataset.name = name;
        const label = document.createElement("div");
        label.className = "icv-el-name";
        label.textContent = name;
        row.appendChild(label);
        const badge = document.createElement("span");
        badge.className = "icv-badge" + (isBase(name) ? " icv-badge-base" : "");
        badge.textContent = isBase(name) ? "BASE" : "CRAFTABLE";
        row.appendChild(badge);
        if (inventory.has(name)) {
          const pill = document.createElement("span");
          pill.className = "icv-inv-pill";
          pill.textContent = "IN";
          row.appendChild(pill);
        }
        row.addEventListener("click", () => {
          const nm = row.dataset.name;
          if (inventory.has(nm)) inventory.delete(nm);
          else inventory.add(nm);
          renderInventory();
          renderCraftables();
          renderAlmost();
          renderElements(searchInput.value || "");
        });
        row.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          currentTraceTarget = name;
          renderTraceFor(name);
        });
        listEl.appendChild(row);
      }
    }

    async function loadRecipes(bust = false) {
      try {
        statusEl.textContent = "Loading‚Ä¶";
        const url = bust ? BASE_URL + "?t=" + Date.now() : BASE_URL;
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json();
        recipes = data || {};
        allNames = Object.keys(recipes).sort((a, b) => a.localeCompare(b));
        renderElements(searchInput.value || "");
        statusEl.textContent = "Loaded " + allNames.length + " elements.";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to load source.";
      }
    }

    searchInput.addEventListener("input", (e) => renderElements(e.target.value));
    reloadBtn.addEventListener("click", () => loadRecipes(true));
    stepsInput.addEventListener("change", () => renderAlmost());
    loadRecipes(false);
  </script>
</body>
</html>
