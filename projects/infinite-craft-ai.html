<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infinite Craft Visualizer | CatSu</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="https://catsu-osm.github.io/styles.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>

  <style>
    main { max-width: 1000px; margin: 0 auto; padding: 1rem; }
    #graph { width: 100%; height: 70vh; border: 1px solid #ccc; border-radius: 8px; }
    #controls { margin-bottom: 1rem; display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
    #controls input { padding: .4rem; }
    #errorBox {
      display: none;
      background: #ffdddd;
      border: 1px solid #ff6b6b;
      color: #7a0000;
      padding: .5rem .75rem;
      border-radius: 6px;
      margin-bottom: .75rem;
    }
    #jsonFallback {
      display: none;
      width: 100%;
      height: 150px;
      margin-bottom: .5rem;
    }
    #tooltip {
      position: absolute;
      background: rgba(30,30,30,0.85);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      display: none;
      z-index: 2000;
    }
  </style>
</head>
<body>
  <header>
    <h2>
      <a href="https://catsu-osm.github.io" style="text-decoration:none;">
        <i class="fas fa-home" style="margin-right:10px;"></i>
      </a>
      CatSu's Website
    </h2>
    <nav>
      <button onclick="location.href='https://catsu-osm.github.io/projects'">Projects</button>
      <button onclick="location.href='https://catsu-osm.github.io/resources'">Resources</button>
      <button onclick="location.href='https://catsu-osm.github.io/projects/infinite-craft-ai.html'">Infinite Craft</button>
    </nav>
  </header>

  <main>
    <h2>Infinite Craft Recipe Visualizer</h2>
    <p>
      Loads from <code>/docs/infinite_craft_recipes.json</code>. If the file isn’t there yet,
      you can paste JSON below and click “Load pasted JSON”.
    </p>

    <div id="errorBox"></div>

    <div id="controls">
      <input id="searchBox" type="text" placeholder="Search element..." />
      <button type="button" onclick="highlightNode()">Find</button>
      <button type="button" onclick="resetView()">Reset View</button>
      <button type="button" onclick="togglePaste()">Paste JSON…</button>
      <button type="button" onclick="reloadData()">Reload file</button>
    </div>

    <textarea id="jsonFallback" placeholder='Paste the contents of infinite_craft_recipes.json here…'></textarea>
    <button id="loadPastedBtn" style="display:none;margin-bottom:1rem;" onclick="loadPasted()">Load pasted JSON</button>

    <div id="graph"></div>
  </main>

  <footer style="position:fixed;bottom:0;width:100%;background-color:#99c2ff;color:#fff;text-align:right;padding:1em;box-sizing:border-box;z-index:1000;">
    <p>&copy; CatSu 2025</p>
  </footer>

  <div id="tooltip"></div>

  <script>
    const DATA_URL = "/docs/infinite_craft_recipes.json"; // <- your file

    const width = document.body.clientWidth;
    const height = window.innerHeight * 0.65;
    const svg = d3.select("#graph").append("svg")
      .attr("width", "100%")
      .attr("height", height);

    let simulation, nodes = [], links = [];

    function showError(msg) {
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      box.style.display = "block";
    }
    function hideError() {
      const box = document.getElementById("errorBox");
      box.style.display = "none";
    }

    async function loadData() {
      hideError();
      try {
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json();
        buildGraph(data);
      } catch (err) {
        console.error(err);
        showError("Could not load " + DATA_URL + ". Make sure the file exists in your repo.");
      }
    }

    function buildGraph(recipes) {
      svg.selectAll("*").remove(); // clear

      nodes = Object.keys(recipes).map(k => ({
        id: k,
        base: !!(recipes[k] && recipes[k]._base)
      }));

      const idMap = new Map(nodes.map(n => [n.id, n]));
      links = [];

      for (const [out, node] of Object.entries(recipes)) {
        if (!node || !Array.isArray(node.recipes)) continue;
        for (const opt of node.recipes) {
          if (!Array.isArray(opt)) continue;
          for (const ing of opt) {
            if (ing !== out && idMap.has(ing)) {
              links.push({ source: ing, target: out });
            }
          }
        }
      }

      render();
    }

    function render() {
      simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(80))
        .force("charge", d3.forceManyBody().strength(-200))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg.selectAll(".link")
        .data(links)
        .enter()
        .append("line")
        .attr("class", "link")
        .attr("stroke", "#aaa")
        .attr("stroke-opacity", 0.6);

      const node = svg.selectAll(".node")
        .data(nodes)
        .enter()
        .append("circle")
        .attr("r", 6)
        .attr("fill", d => d.base ? "#3399ff" : "#2ecc71")
        .call(drag(simulation))
        .on("mouseover", function (e, d) {
          d3.select(this).attr("r", 10);
          showTooltip(e, d.id);
        })
        .on("mouseout", function () {
          d3.select(this).attr("r", 6);
          hideTooltip();
        });

      const label = svg.selectAll(".label")
        .data(nodes)
        .enter()
        .append("text")
        .text(d => d.id)
        .attr("font-size", "10px")
        .attr("dx", 8)
        .attr("dy", 3);

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        label
          .attr("x", d => d.x)
          .attr("y", d => d.y);
      });
    }

    function drag(sim) {
      function dragstarted(event, d) {
        if (!event.active) sim.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      }
      function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
      function dragended(event, d) {
        if (!event.active) sim.alphaTarget(0);
        d.fx = null; d.fy = null;
      }
      return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
    }

    function showTooltip(e, text) {
      const t = document.getElementById("tooltip");
      t.textContent = text;
      t.style.left = e.pageX + 10 + "px";
      t.style.top = e.pageY + "px";
      t.style.display = "block";
    }

    function hideTooltip() {
      document.getElementById("tooltip").style.display = "none";
    }

    function highlightNode() {
      const q = document.getElementById("searchBox").value.trim().toLowerCase();
      svg.selectAll("circle").attr("stroke", null).attr("stroke-width", null);
      if (!q) return;
      svg.selectAll("circle")
        .filter(d => d.id.toLowerCase() === q)
        .attr("stroke", "red")
        .attr("stroke-width", 3);
    }

    function resetView() {
      document.getElementById("searchBox").value = "";
      svg.selectAll("circle").attr("stroke", null).attr("stroke-width", null);
      if (simulation) {
        simulation.alpha(1).restart();
      }
    }

    function togglePaste() {
      const ta = document.getElementById("jsonFallback");
      const btn = document.getElementById("loadPastedBtn");
      const visible = ta.style.display === "block";
      ta.style.display = visible ? "none" : "block";
      btn.style.display = visible ? "none" : "inline-block";
    }

    function loadPasted() {
      const txt = document.getElementById("jsonFallback").value;
      if (!txt.trim()) return;
      try {
        const obj = JSON.parse(txt);
        buildGraph(obj);
        hideError();
      } catch (e) {
        showError("Pasted JSON was not valid: " + e.message);
      }
    }

    function reloadData() {
      loadData();
    }

    loadData();
  </script>
</body>
</html>
