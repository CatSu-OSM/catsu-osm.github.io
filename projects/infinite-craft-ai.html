<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infinite Craft Visualizer ‚Äì CatSu</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />
  <link rel="stylesheet" href="https://catsu-osm.github.io/styles.css" />
  <style>
    /* scoped dark/light vars */
    #icv-app {
      --bg: #edf0f5;
      --panel: #fff;
      --panel-border: #d5d8df;
      --panel-header: #dfe7f5;
      --text: #0f172a;
      --muted: #6b7280;
      --badge: #edf1f5;
      --badge-text: #1f2937;
      --pill: #0ea5e9;
      --trace-ok: #16a34a;
      --trace-miss: #b91c1c;
    }
    #icv-app.icv-dark {
      --bg: #0f172a;
      --panel: #111827;
      --panel-border: #1f2937;
      --panel-header: #1f2937;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --badge: #1f2937;
      --badge-text: #e2e8f0;
    }

    .icv-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1rem;
    }
    .icv-left {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
    }
    .icv-left-head {
      background: var(--panel-header);
      padding: 0.6rem 0.8rem 0.3rem;
    }
    .icv-left-head h2 {
      margin: 0;
      font-size: 1rem;
      color: var(--text);
    }
    .icv-left-head small {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .icv-search {
      padding: 0.6rem 0.8rem;
    }
    .icv-search input {
      width: 100%;
      padding: 0.35rem 0.4rem;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #fff;
      color: var(--text);
      font-size: 0.8rem;
    }
    .icv-element-row {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.6rem;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      user-select: none;
    }
    .icv-element-row:hover {
      background: #f2f6ff;
    }
    .icv-element-row.icv-inv {
      background: #dbeafe;
    }
    .icv-el-name {
      flex: 1;
      font-size: 0.8rem;
      color: var(--text);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .icv-badge {
      font-size: 0.6rem;
      background: var(--badge);
      color: var(--badge-text);
      padding: 2px 6px;
      border-radius: 999px;
      text-transform: uppercase;
    }
    .icv-badge-base {
      background: #22c55e1a;
      color: #22c55e;
    }
    .icv-inv-pill {
      font-size: 0.6rem;
      background: var(--pill);
      color: #fff;
      border-radius: 999px;
      padding: 2px 6px;
    }
    .icv-right {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .icv-card {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 8px;
    }
    .icv-card-header,
    .icv-card-header-inline {
      background: var(--panel-header);
      padding: 0.6rem 0.8rem;
      color: var(--text);
      font-size: 1rem;
    }
    .icv-card-header-inline {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .icv-card-body {
      padding: 0.6rem 0.8rem 0.8rem;
    }
    .icv-trace-title {
      font-weight: 600;
    }
    .icv-trace-step {
      border-left: 3px solid transparent;
      padding: 0.3rem 0.4rem;
      font-size: 0.72rem;
      border-radius: 4px;
    }
    .icv-trace-ok {
      border-left-color: var(--trace-ok);
    }
    .icv-trace-list {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
  </style>
</head>

<body>
  <header>
    <h2>
      <a href="https://catsu-osm.github.io" style="text-decoration:none">
        <i class="fas fa-home" style="margin-right:10px"></i>
      </a>
      CatSu's Website
    </h2>
    <nav>
      <button onclick="location.href='https://catsu-osm.github.io/projects'">
        Projects
      </button>
      <button onclick="location.href='https://catsu-osm.github.io/resources'">
        Resources
      </button>
    </nav>
  </header>

  <main>
    <div id="icv-app">
      <div class="icv-layout">
        <section class="icv-left">
          <div class="icv-left-head">
            <h2>Infinite Craft Elements</h2>
            <small
              >Click to add/remove from inventory, right-click to trace (bases
              only)</small
            >
          </div>
          <div class="icv-search">
            <input
              id="search"
              type="text"
              placeholder="Filter elements..."
            />
          </div>
          <div id="elist" style="flex:1;overflow-y:auto"></div>
        </section>

        <section class="icv-right">
          <div class="icv-card">
            <div class="icv-card-header">Your Inventory</div>
            <div class="icv-card-body" id="invbody">
              <p style="font-size:0.8rem;color:var(--muted)">
                No elements selected.
              </p>
            </div>
          </div>

          <div class="icv-card">
            <div class="icv-card-header">Craftable Right Now</div>
            <div class="icv-card-body" id="craftbody">
              <p style="font-size:0.8rem;color:var(--muted)">
                Select elements to see results.
              </p>
            </div>
          </div>

          <div class="icv-card">
            <div class="icv-card-header-inline">
              <span>Trace Element</span>
            </div>
            <div class="icv-card-body" id="tracebody">
              <p style="font-size:0.8rem;color:var(--muted)">
                Right-click an element on the left to trace from bases.
              </p>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; CatSu 2023</p>
  </footer>

  <script>
    const URL = "../docs/infinite_craft_recipes.json";
    const elist = document.getElementById("elist");
    const invBody = document.getElementById("invbody");
    const craftBody = document.getElementById("craftbody");
    const traceBody = document.getElementById("tracebody");
    const search = document.getElementById("search");

    let recipes = {};
    let all = [];
    let inv = new Set();

    function isBase(n) {
      const r = recipes[n];
      return r && r._base === true;
    }
    function opts(n) {
      const r = recipes[n];
      return r && Array.isArray(r.recipes) ? r.recipes : [];
    }

    function renderList(filt = "") {
      elist.innerHTML = "";
      const ft = filt.trim().toLowerCase();
      for (const n of all) {
        if (ft && !n.toLowerCase().includes(ft)) continue;
        const row = document.createElement("div");
        row.className = "icv-element-row" + (inv.has(n) ? " icv-inv" : "");
        row.innerHTML = `<div class="icv-el-name">${n}</div>
        <span class="icv-badge${isBase(n) ? " icv-badge-base" : ""}">${
          isBase(n) ? "BASE" : "CRAFT"
        }</span>`;
        row.onclick = () => {
          if (inv.has(n)) inv.delete(n);
          else inv.add(n);
          renderList(ft);
        };
        row.oncontextmenu = (e) => {
          e.preventDefault();
          traceBody.innerHTML = "";
          renderTrace(n);
        };
        elist.appendChild(row);
      }
    }

    function canMake(n, set) {
      if (set.has(n)) return false;
      for (const o of opts(n)) {
        if (o.every((x) => set.has(x))) return true;
      }
      return false;
    }

    function renderTrace(target) {
      const bases = new Set(all.filter((x) => isBase(x)));
      const trace = findTrace(target, bases);
      const tb = traceBody;
      tb.innerHTML = "";
      if (!trace) {
        tb.innerHTML = `<p style="font-size:0.8rem;color:var(--muted)">No path from bases found.</p>`;
        return;
      }
      const title = document.createElement("div");
      title.className = "icv-trace-title";
      title.textContent = "Trace for: " + target;
      tb.appendChild(title);

      const list = document.createElement("div");
      list.className = "icv-trace-list";
      for (const st of trace) {
        const r = document.createElement("div");
        r.className = "icv-trace-step icv-trace-ok";
        if (st.type === "have")
          r.textContent = `‚úÖ Have ${st.name}`;
        else
          r.textContent = `üõ†Ô∏è ${st.name} = ${st.recipe.join(" + ")}`;
        list.appendChild(r);
      }
      tb.appendChild(list);
    }

    function findTrace(target, start, depth = 20, seen = new Set()) {
      if (start.has(target)) return [{ type: "have", name: target }];
      if (depth <= 0) return null;
      const o = opts(target);
      if (!o.length) return null;
      for (const rec of o) {
        if (rec.every((x) => start.has(x))) {
          return [
            ...rec.map((x) => ({ type: "have", name: x })),
            { type: "make", name: target, recipe: rec },
          ];
        }
        if (seen.has(target)) continue;
        const newSeen = new Set(seen);
        newSeen.add(target);
        let steps = [];
        let cur = new Set(start);
        let fail = false;
        for (const ing of rec) {
          if (!cur.has(ing)) {
            const sub = findTrace(ing, cur, depth - 1, newSeen);
            if (!sub) {
              fail = true;
              break;
            }
            steps = steps.concat(sub);
            cur.add(ing);
          } else {
            steps.push({ type: "have", name: ing });
          }
        }
        if (!fail) {
          steps.push({ type: "make", name: target, recipe: rec });
          return steps;
        }
      }
      return null;
    }

    async function load() {
      const res = await fetch(URL);
      recipes = await res.json();
      all = Object.keys(recipes).sort((a, b) => a.localeCompare(b));
      renderList();
    }

    search.oninput = (e) => renderList(e.target.value);
    load();
  </script>
</body>
</html>
